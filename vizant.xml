<?xml version="1.0" encoding="UTF-8"?>
<project name="vizant-macro" default="vizmain">

    <path id="viz.classpath">
        <pathelement path="${vizant.jar}"/>
    </path>

    <taskdef name="vizant"
             classname="net.sourceforge.vizant.Vizant"
             classpathref="viz.classpath"/>

    <target name="vizinit" depends="vizdotexec">
        <fail unless="viz.antfile"
              message="must set viz.antfile=build/file.xml"/>
        <tstamp />
        <property name="viz.dts" value="${DSTAMP}${TSTAMP}"/>
        <!-- if already set in vizwindowscheck than the override ignored keeps it set, else unix -->
        <property name="viz.dotexec" value="dot" />
        <!-- if already set than the override is ignored -->
        <property name="vizant.jar" value="build/vizant.jar" />        
    </target>

    <target name="vizdotexec" depends="vizwindowscheck" if="vizdot.exe.present">
        <property name="viz.dotexec" value="${vizdot.exe}" />    
    </target>

    <target name="vizwindowscheck">
        <property name="vizdot.exe" value="C:\Program Files\Graphviz 2.28\bin\dot.exe"/>
        <available file="${vizdot.exe}" property="vizdot.exe.present"/>            
    </target>

    <target name="vizmain" depends="vizinit">
    	<property name="viz.file" value="${viz.antfile}"/>
        <vizdot antfile="${viz.file}"/>
    </target>

    <macrodef name="vizdot">
        <attribute name="antfile"/>
        <element name="viz-elements" optional="yes"/>
        <sequential>
            <property name="viz.to" value="" />
            <property name="viz.from" value="" />
            <property name="viz.antfileMap" value="" />
            <property name="viz.target.antfile" value="@{antfile}" />
            <property name="viz.output.dir" value="." />
            <property name="viz.output.format" value="png" />
            <property name="viz.nocluster" value="false" />
            <property name="viz.uniqueref" value="false" />
            <property name="viz.ignoreant" value="false" />
            <property name="viz.ignoreimport" value="false" />
            <property name="viz.ignoreantcall" value="false" />
            <property name="viz.ignoredepends" value="false" />
            <property name="viz.dotexec" value="dot" />

            <basename property="viz.base.jar" file="${vizant.jar}" />
            <basename property="viz.jar.name" file="${viz.base.jar}" suffix=".jar" />
            <basename property="viz.base.filename" file="${viz.antfile}" suffix=".xml" />
    
            <property name="viz.output.file"
                      value="${viz.output.dir}/${viz.dts}-${viz.base.filename}-${viz.jar.name}-${viz.from}-${viz.to}" />
        
            <echo message="vizant on ${viz.target.antfile}"/>

            <vizant to="${viz.to}"
                from="${viz.from}"
                antfile="${viz.target.antfile}"
                antfileMap="${viz.antfileMap}"
                nocluster="${viz.nocluster}"
                uniqueref="${viz.uniqueref}"
                ignoreant="${viz.ignoreant}"
                ignoreimport="${viz.ignoreimport}"
                ignoreantcall="${viz.ignoreantcall}"
                ignoredepends="${viz.ignoredepends}"
                outfile="${viz.output.file}.dot">
                
                <viz-elements/>                
            </vizant>

            <echo message="Saving using ${viz.output.file} see vizant.xml source for -D overrides"/>
                
            <exec executable="${viz.dotexec}">
                <arg line="-T${viz.output.format} ${viz.output.file}.dot -o ${viz.output.file}.${viz.output.format}"/>
            </exec>

        </sequential>
    </macrodef>

</project>
